local cjson = require "cjson"
local http = require "resty.http"
local uuid = require "resty.jit-uuid"

-- Seed the random number generator
uuid.seed()

local Tracing = {}

function Tracing:new()
    local instance = {
        spans = {},
        context = {}
    }
    setmetatable(instance, { __index = Tracing })
    return instance
end

function Tracing:create_span(name)
    local span = {
        trace_id = uuid(),
        span_id = uuid(),
        name = name,
        start_time = ngx.now(),
        end_time = nil,
        attributes = {}
    }
    table.insert(self.spans, span)
    return span
end

function Tracing:end_span(span)
    span.end_time = ngx.now()
end

function Tracing:add_attribute(span, key, value)
    span.attributes[key] = value
end

function Tracing:export_span(span)
    local trace_data = {
        -- Populate the trace data structure
        -- Convert timestamps to the required format
    }
    return cjson.encode(trace_data)
end

function Tracing:send_trace_to_collector(trace_data)
    local httpc = http.new()
    local res, err = httpc:request_uri("http://otel-collector:port/v1/traces", {
        method = "POST",
        body = trace_data,
        headers = {
            ["Content-Type"] = "application/json",
        },
    })

    if not res then
        ngx.log(ngx.ERR, "Failed to send trace data: ", err)
        return
    end

    if res.status < 200 or res.status >= 300 then
        ngx.log(ngx.ERR, "Failed to send trace data, status: ", res.status)
    end
end

return Tracing
